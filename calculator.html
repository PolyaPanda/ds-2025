    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Финансовый калькулятор (Шаг 3: 4 операнда и приоритеты)</title>
        <style>
            body {
                font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                display: grid;
                place-items: center;
                min-height: 90vh;
                background-color: #f4f7f6;
                color: #333;
                background-image: url('pexels-eberhardgross-1612367.jpg');
                background-repeat: no-repeat;
                background-size: cover;
            }
            .calculator {
                background-color: #ffffff;
                border-radius: 12px;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
                padding: 28px;
                width: 480px;
                margin: 20px auto;
            }
            .student-info {
                font-size: 0.9em;
                color: #777;
                border-top: 1px solid #eee;
                padding-top: 15px;
            }
            .form-group {
                margin-bottom: 10px;
                font-family: 'Montserrat';
                display: flex;
                align-items: center;
            }
            .form-group.res {
                display: block;
            }
            .form-group.res label {
                margin-top: 20px;
            }
            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 400;
                font-size: 1.1em;
            }
            .operand-input {
                flex-grow: 1;
            }
            .op-select {
                width: 70px;
                margin: 0 10px;
            }
            input, select {
                padding: 10px;
                font-size: 1.1em;
                border: 1px solid #ddd;
                border-radius: 6px;
                box-sizing: border-box;
                font-family: 'Montserrat';
            }
            button {
                width: 100%;
                padding: 12px;
                font-size: 1.1em;
                font-weight: 700;
                color: #fff;
                background-color: #8c401f;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.2s;
                font-family: 'Montserrat';
            }
            button:active {
                background-color: #5c2e1a;
            }
            #result-container {
                margin-top: 20px;
                font-size: 1.1em;
                font-weight: 400;
                color: #333;
                min-height: 1.5em;
                word-wrap: break-word;
                background-color: rgba(140, 64, 31, 0.1);
                padding: 10px;
                border-radius: 6px;
            }
            #rounded-result-container {
                font-size: 1.2em;
                font-weight: 700;
                color: #5c2e1a;
                margin-top: 10px;
                background-color: rgba(140, 64, 31, 0.2);
                padding: 10px;
                border-radius: 6px;
            }
            .error {
                color: #d93025;
                font-size: 0.8em;
                margin-top: 5px;
                min-height: 1.3em;
            }
            h2 { margin-top: 0px; }
        </style>
    </head>
    <body>

        <div class="calculator">
        <h2>Калькулятор приоритетов</h2>
        

        <div class="form-group">
            <input type="text" id="num1" class="operand-input" placeholder="Операнд 1" value="0">
        </div>
        <div id="error1" class="error"></div>

        <div class="form-group">
            <select id="op1" class="op-select">
                <option value="add" selected>+</option>
                <option value="subtract">-</option>
                <option value="multiply">*</option>
                <option value="divide">/</option>
            </select>
            <div class="error"></div>
        </div>

        <div class="form-group" style="background-color: #f0f8ff; padding: 5px; border-radius: 5px;">
            <input type="text" id="num2" class="operand-input" placeholder="Операнд 2" value="0">
        </div>
        <div id="error2" class="error"></div>

        <div class="form-group" style="background-color: #f0f8ff; padding: 5px; border-radius: 5px;">
            <select id="op2" class="op-select">
                <option value="add" selected>+</option>
                <option value="subtract">-</option>
                <option value="multiply">*</option>
                <option value="divide">/</option>
            </select>
            <div class="error"></div>
        </div>
        
        <div class="form-group" style="background-color: #f0f8ff; padding: 5px; border-radius: 5px;">
            <input type="text" id="num3" class="operand-input" placeholder="Операнд 3" value="0">
        </div>
        <div id="error3" class="error"></div>

        <div class="form-group">
            <select id="op3" class="op-select">
                <option value="add" selected>+</option>
                <option value="subtract">-</option>
                <option value="multiply">*</option>
                <option value="divide">/</option>
            </select>
            <div class="error"></div>
        </div>
        
        <div class="form-group">
            <input type="text" id="num4" class="operand-input" placeholder="Операнд 4" value="0">
        </div>
        <div id="error4" class="error"></div>

        <button id="calculateBtn">Вычислить</button>

        <div class="form-group res">
            <label>Итоговый результат (10 знаков):</label>
            <div id="result-container"></div>
            <div id="errorResult" class="error"></div>
        </div>

        <div class="form-group res">
            <label for="rounding-method">Выбор округления до целых:</label>
            <select id="rounding-method">
                <option value="mathematical">Математическое</option>
                <option value="bankers">Бухгалтерское</option>
                <option value="truncate">Усечение</option>
            </select>
            <label style="margin-top: 10px;">Округленное значение:</label>
            <div id="rounded-result-container"></div>
        </div>

        <div class="student-info">
            Кулагина Полина Владиславовна
            <br>Курс 4, группа 4
            <br>2025
        </div>
    </div>
    <script>
        const SCALE = 10;
        const SCALE_BI = 10n ** BigInt(SCALE); // 10 000 000 000
        
        // Диапазон: ± 1 000 000 000 000.0000000000 (12 целых + 10 дробных)
        // Максимальное внутреннее значение = 10^12 * 10^10 = 10^22 (1 и 22 нуля)
        const MAX_ABS_VALUE = 10n ** 22n; 

        const numInputs = ['num1', 'num2', 'num3', 'num4'].map(id => document.getElementById(id));
        const opSelects = ['op1', 'op2', 'op3'].map(id => document.getElementById(id));
        const errorElements = ['error1', 'error2', 'error3', 'error4'].map(id => document.getElementById(id));
        const roundingMethodSelect = document.getElementById('rounding-method');
        const resultContainer = document.getElementById('result-container');
        const roundedResultContainer = document.getElementById('rounded-result-container');
        const calculateBtn = document.getElementById('calculateBtn');
        const errorResult = document.getElementById('errorResult');
        
        let finalResultBigInt = 0n;

        function clearErrors() {
            errorResult.textContent = '';
            errorElements.forEach(err => err.textContent = '');
            roundedResultContainer.textContent = '';
        }
        
    
        function divideAndRound(dividend, divisor) {
            if (divisor === 0n) throw new Error("Деление на ноль!");
            
            const sign = (dividend < 0n) !== (divisor < 0n) ? -1n : 1n;
            let num = dividend < 0n ? -dividend : dividend;
            let den = divisor < 0n ? -divisor : divisor;

            let quotient = num / den;
            let remainder = num % den;

            if (remainder * 2n >= den) {
                quotient += 1n;
            }

            return sign * quotient;
        }

    
        function formatFromScaledBigInt(value) {
            const isNegative = value < 0n;
            let absValueStr = (isNegative ? -value : value).toString();

            absValueStr = absValueStr.padStart(SCALE + 1, '0');

            let integerPart = absValueStr.slice(0, -SCALE);
            let fractionalPart = absValueStr.slice(-SCALE);

            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");

            fractionalPart = fractionalPart.replace(/0+$/, '');
            
            const sign = isNegative ? '-' : '';

            if (fractionalPart.length === 0) {
                return sign + integerPart;
            } else {
                return sign + integerPart + '.' + fractionalPart;
            }
        }

        function roundToInteger(value, method) {
            const isNegative = value < 0n;
            const absValue = isNegative ? -value : value;
            
            let integerPart = absValue / SCALE_BI;
            const fractionalPart = absValue % SCALE_BI;
            const halfScale = SCALE_BI / 2n;
            
            if (method === 'truncate') {
                return formatInteger(isNegative ? -integerPart : integerPart);
            }

            if (method === 'mathematical') {
                if (fractionalPart >= halfScale) {
                    integerPart += 1n;
                }
                return formatInteger(isNegative ? -integerPart : integerPart);
            }

            if (method === 'bankers') {
                if (fractionalPart === halfScale) {
                    if (integerPart % 2n !== 0n) {
                        integerPart += 1n;
                    }
                } else if (fractionalPart > halfScale) {
                    integerPart += 1n;
                } 

                return formatInteger(isNegative ? -integerPart : integerPart);
            }
        }
        
        function formatInteger(value) {
            const sign = value < 0n ? '-' : '';
            const absValueStr = (value < 0n ? -value : value).toString();
            const formattedInt = absValueStr.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            return sign + formattedInt;
        }

        
        function parseToScaledBigInt(str, errorElement) {
            let input = str.trim();
            if (!input) {
                errorElement.textContent = "Поле не может быть пустым";
                return null;
            }

            const strictRegex = /^-?(?:(\d{1,3}(?: \d{3})*)|(\d+))([.,]\d+)?$/;

            if (!strictRegex.test(input) || input.includes('e') || input.includes('E')) {
                errorElement.textContent = "Некорректный формат (проверьте пробелы, E-нотацию)";
                return null;
            }
            if (input === "-" || input === ".") {
                errorElement.textContent = "Некорректный формат числа";
                return null;
            }
            if (input.lastIndexOf('-') > 0) {
                errorElement.textContent = "Некорректный формат";
                return null;
            }

            input = input.replace(/\s/g, '').replace(',', '.');

            const isNegative = input.startsWith('-');
            if (isNegative) input = input.substring(1);

            let [integerPart, fractionalPart] = input.split('.');
            integerPart = integerPart || '0';

            const MAX_INPUT_DECIMALS = 6; 
            
            fractionalPart = (fractionalPart || '')
                             .substring(0, MAX_INPUT_DECIMALS)
                             .padEnd(SCALE, '0');        
            
            const fullNumStr = integerPart + fractionalPart;
            
            let value = BigInt(fullNumStr);

            if (value >= MAX_ABS_VALUE) { 
                errorElement.textContent = "Число превышает допустимый диапазон (± 1 трлн)";
                return null;
            }

            return isNegative ? -value : value;
        }
        
        function performOperation(op, val1, val2) {
            let result;
            switch (op) {
                case 'add':
                    result = val1 + val2;
                    break;
                case 'subtract':
                    result = val1 - val2;
                    break;
                case 'multiply':
                    result = divideAndRound(val1 * val2, SCALE_BI);
                    break;
                case 'divide':
                    if (val2 === 0n) throw new Error("Деление на ноль!");
                    result = divideAndRound(val1 * SCALE_BI, val2);
                    break;
                default:
                    throw new Error("Неизвестная операция");
            }

            if (result >= MAX_ABS_VALUE || result <= -MAX_ABS_VALUE) {
                throw new Error("Переполнение промежуточного вычисления");
            }
            
            return result;
        }


        calculateBtn.addEventListener('click', () => {
    clearErrors();
    resultContainer.textContent = '';
    roundedResultContainer.textContent = '';
    finalResultBigInt = 0n; 
    try {
        const values = numInputs.map((input, index) => 
            parseToScaledBigInt(input.value, errorElements[index])
        );
        const ops = opSelects.map(select => select.value);

        if (values.includes(null)) return;
        
        const [valA, valB, valC, valD] = values;
        const [op1, op2, op3] = ops;
        const resultX = performOperation(op2, valB, valC, "в скобках (Оп2)");

        
        let val1 = valA;
        let val2 = resultX;
        let val3 = valD;
        
        let currentResult;
        
        if (op1 === 'multiply' || op1 === 'divide') {
            currentResult = performOperation(op1, val1, val2, "Оп1 (* или /)");
            
            finalResultBigInt = performOperation(op3, currentResult, val3, "Оп3 (финальная)");
            
        } else if (op3 === 'multiply' || op3 === 'divide') {
            const resultY = performOperation(op3, val2, val3, "Оп3 (* или /)");
            
            finalResultBigInt = performOperation(op1, val1, resultY, "Оп1 (+ или -), финальная");
            
        } else {
            currentResult = performOperation(op1, val1, val2, "Оп1 (+ или -)");
            finalResultBigInt = performOperation(op3, currentResult, val3, "Оп3 (+ или -), финальная");
        }

        resultContainer.textContent = formatFromScaledBigInt(finalResultBigInt);

        const method = roundingMethodSelect.value;
        roundedResultContainer.textContent = roundToInteger(finalResultBigInt, method);

    } catch (error) {
        errorResult.textContent = error.message;
        roundedResultContainer.textContent = '';
    }
});
        roundingMethodSelect.addEventListener('change', () => {
            if (finalResultBigInt !== 0n && resultContainer.textContent) {
                const method = roundingMethodSelect.value;
                roundedResultContainer.textContent = roundToInteger(finalResultBigInt, method);
            }
        });

    </script>
</body>
</html>
